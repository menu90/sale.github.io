<!DOCTYPE html>
<html>  
<head>  
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="menu">
	<title>煎饼售卖</title>
	<!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<!--<link href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">-->


    <!-- Custom Fonts -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="./jquery-1.8.2.min.js"></script>
	<!--<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>-->
    <script type="text/javascript"> 
		function initDatabase() {
            var db = getCurrentDb();//初始化数据库
            if(!db) {alert("您的浏览器不支持HTML5本地数据库");return;}
            db.transaction(function (trans) {//启动一个事务，并设置回调函数
                //执行创建表的Sql脚本
                trans.executeSql("create table if not exists Sale(name text null,num text null)",
				[], function (trans, result) {
                }, function (trans, message) {//消息的回调函数
					alert(message);
					}
				);
            }, function (trans, result) {
            }, function (trans, message) {
            });
        }	
		$(function () {//页面加载完成后绑定页面按钮的点击事件
            initDatabase();
            
			$('#export').click(function(){
                var db = getCurrentDb();
				var dataSale =[];
				db.transaction(function (trans) {
					trans.executeSql("select * from sale ", [], function (ts, data) {
						if (data) {
						alert(console.log(data));
							var title=[{name:'产品名称'},{num:'数量'}]; 
							toExcel("Report", data.rows, title);
						}
					}, function (ts, message) {alert(message);var tst = message;});
				});
			});  
			
			//清空数据库
			$('#clear').click(function(){  
                var db = getCurrentDb();
				var dataSale =[];
				db.transaction(function (trans) {
					trans.executeSql("delete from sale ", [], function (ts, data) {
						alert("数据清空成功！");
					}, function (ts, message) {alert(message);var tst = message;});
				});
            });  
			
			//出售
			$('#sales').click(function(){
				var flag = true;
				var tabObj = $('#saleTab');
				var trObj = tabObj.find('tr');
				var db = getCurrentDb();
				var sql = "insert into Sale(name,num) values";
				for(var i=1;i<trObj.length;i++){
					var num = $('#num'+i).val();
					if(num > 0){
						flag = false;
						var name = $('#name'+i).text();
						//console.log('num:'+num +",name:"+name);
						//执行sql脚本，插入数据
						sql += "('" + name + "'," + num + "),"
						
					}
				}
				if(flag){
					alert('请输入购买数量');
					return;
				}
				sql = sql.substring(0, sql.length-1);
				db.transaction(function (trans) {
							trans.executeSql(sql, [], function (ts, data) {
							}, function (ts, message) {
								alert(message);
							});
						});
				//console.log(sql);
				for(var i=1;i<trObj.length;i++){
					$('#num'+i).val('');
				}
				
			})
        });
        function getCurrentDb() {
            //打开数据库，或者直接连接数据库参数：数据库名称，版本，概述，大小
            //如果数据库不存在那么创建之
            var db = openDatabase("myDb", "1.0", "it's to save sale data!", 1024 * 1024); ;
            return db;
        }
        //FileName 生成的Excel文件名称
        function toExcel(FileName, JSONData, ShowLabel) {  
            //先转化json  
            var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;  
              
            var excel = '<table>';      
              
            //设置表头  
            var row = "<tr align='left'>";//设置Excel的左居中
            for (var i = 0, l = ShowLabel.length; i < l; i++) {  
                for (var key in ShowLabel[i]) {
                    row += "<td>" + ShowLabel[i][key] + '</td>';  
                }
            }  
              
              
            //换行  
            excel += row + "</tr>";  
              
            //设置数据  
            for (var i = 0; i < arrData.length; i++) {  
                var rowData = "<tr align='left'>"; 

                for (var y = 0; y < ShowLabel.length; y++) {
                    for(var k in ShowLabel[y]){
                        if (ShowLabel[y].hasOwnProperty(k)) {
                             rowData += "<td style='vnd.ms-excel.numberformat:@'>" + (arrData[i][k]===null? "" : arrData[i][k]) + "</td>";
　　　　　　　　　　　　　　　　　 //vnd.ms-excel.numberformat:@ 输出为文本
                        }
                    }
                }

                excel += rowData + "</tr>";  
            }  
  
            excel += "</table>";  
  
            var excelFile = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'>";  
            excelFile += '<meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">';  
            excelFile += '<meta http-equiv="content-type" content="application/vnd.ms-excel';  
            excelFile += '; charset=UTF-8">';  
            excelFile += "<head>";  
            excelFile += "<!--[if gte mso 9]>";  
            excelFile += "<xml>";  
            excelFile += "<x:ExcelWorkbook>";  
            excelFile += "<x:ExcelWorksheets>";  
            excelFile += "<x:ExcelWorksheet>";  
            excelFile += "<x:Name>";  
            excelFile += "{worksheet}";  
            excelFile += "</x:Name>";  
            excelFile += "<x:WorksheetOptions>";  
            excelFile += "<x:DisplayGridlines/>";  
            excelFile += "</x:WorksheetOptions>";  
            excelFile += "</x:ExcelWorksheet>";  
            excelFile += "</x:ExcelWorksheets>";  
            excelFile += "</x:ExcelWorkbook>";  
            excelFile += "</xml>";  
            excelFile += "<![endif]-->";  
            excelFile += "</head>";  
            excelFile += "<body>";  
            excelFile += excel;  
            excelFile += "</body>";  
            excelFile += "</html>";  
  
              
            var uri = 'data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(excelFile);  
              
            var link = document.createElement("a");      
            link.href = uri;  
              
            link.style = "visibility:hidden";  
            link.download = FileName + ".xls";  
              
            document.body.appendChild(link);  
            link.click();  
            document.body.removeChild(link);  
        }  
		
    </script>  
</head>  
<body> 
	<div id="wrapper">
		
		<div class="row">
			<div class="col-sm-12">
				<div class="panel panel-info">
					<div class="panel-heading">
						<h3 class="panel-title" style="text-align:center;">煎饼出售</h3>
					</div>
					<div class="panel-body">
						 <table class="table table-striped" id="saleTab" style="text-align:center;">
							<th style="text-align:center;">产品名称</th><th style="text-align:center;">数量 </th>
							<tr>
								<td id="name1">AAA</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num1" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name2">BBB</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num2" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name3">CCC</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num3" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name4">DDD</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num4" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name5">GGG</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num5" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name6">EEE</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num6" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name7">FFF</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num7" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name8">LLL</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num8" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name9">KKK</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num9" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
							<tr>
								<td id="name10">III</td>
								<td>
								<div class="col-lg-3">
									<input type="number" class="form-control" id="num10" placeholder="请输入购买数量">
								</div>
								</td>
							</tr>
						</table>
						<div style="text-align:center"><button type="button" class="btn btn-primary" id="sales">出售</button></div>
						<br/>
						<button type="button" class="btn btn-success" id="export">导出</button>
						<button type="button" class="btn btn-warning" id="clear"style="float:right;margin-right:30px;">清空</button>

					</div>
					
				</div>
				
			</div>
		</div>
</div>
</body>  
</html>